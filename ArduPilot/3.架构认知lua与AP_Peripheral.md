# ArduPilot 架构认知篇（Lua / AP_Peripheral）

> 目标读者：
>
> * 正在学习 ArduPilot / Pixhawk 的嵌入式开发者
> * 希望从**工程架构**而非“堆功能”角度理解飞控系统的人
>
> 目标：
>
> * 用**一页说明稿**的标准，解释清楚：
>
>   * 为什么 ArduPilot 要分层
>   * 主飞控 / Lua / AP_Peripheral 各自**负责什么、不负责什么**
>   * 这种设计在**工程、实时性、风险控制**上的价值

---

## 一、核心问题

**为什么 ArduPilot 不把所有功能都写在主飞控里？**

一句话回答：

> 因为飞控是一个**强实时、高风险、可推导性要求极高**的系统，
> **复杂性一旦失控，后果就是“炸机”**。

所以 ArduPilot 必须通过**架构分层**，把“要命的”和“不那么要命的”严格隔离。

---

## 二、从三个工程视角理解分层设计

### 1️⃣ 软件工程视角：解耦 = 可维护 + 少出错

* 主飞控逻辑复杂、修改成本极高
* 外设 / 新功能变化快、试错频繁

👉 如果全部耦合在一起：

* 改一个外设 = 影响飞控主逻辑
* Bug 定位困难
* 维护成本指数级上升

👉 **分层后的结果**：

* 核心飞控逻辑尽量稳定
* 外设和功能可以独立演进
* 出问题时影响范围可控

---

### 2️⃣ 实时性视角：不是所有任务都配得上“最高优先级”

飞控系统里的任务，本质上分为两类：

* **强实时任务**（毫秒级、不可延迟）
* **弱实时 / 非实时任务**（延迟可接受）

如果：

* 非关键逻辑
* 复杂 IO
* 不可控执行时间

混进主调度循环中，

👉 就可能：

* 阻塞姿态控制
* 破坏控制闭环
* 引发不可预测行为

**所以必须分层调度。**

---

### 3️⃣ 风险视角：飞控系统最怕“连带失败”

* 主飞控出错 = 高风险
* 非核心外设出错 = 本不该致命

如果所有功能都在主飞控里：

* 一个外设 Bug
* 一个实验性功能

👉 都可能直接影响飞行安全

**分层的本质：风险隔离。**

---

## 三、ArduPilot 的三层结构

```
┌────────────────────┐
│      主飞控        │  ← 要命的
├────────────────────┤
│        Lua         │  ← 可试错的
├────────────────────┤
│   AP_Peripheral    │  ← 可独立的
└────────────────────┘
```

下面用「负责什么 / 不负责什么」的方式来理解。

---

## 四、主飞控（ArduPilot Core）

### ✅ 负责什么

* 姿态解算与姿态控制（AHRS / Attitude Control）
* 控制闭环（位置、速度、姿态）
* 飞行模式核心逻辑（起飞 / 降落 / 悬停 / 返航等）
* 安全逻辑（Failsafe、RTL）
* **飞行关键外设**（IMU、气压计、电机输出等）

### ❌ 不负责什么

* 复杂 IO
* 不确定执行时间的逻辑
* 实验性功能
* 非飞行关键外设

### 🧠 一句话理解

> 主飞控里的逻辑必须：
> **确定、正确、可推导、可证明安全**。
>
> 任何会破坏这一点的东西，都不应该进来。

---

## 五、AP_Peripheral（外设处理层）

### ✅ 负责什么

* **非飞行关键外设**
* 非必须实时的数据采集
* 外设协议处理（传感器、扩展模块等）
* 相对复杂但不影响飞行安全的功能

### ❌ 不负责什么

* 姿态解算
* 控制闭环
* 安全与飞行决策逻辑

### 🧠 一句话理解

> AP_Peripheral 负责：
> **就算它挂了，飞机也不该立刻出事的东西。**

---

## 六、Lua（脚本与实验层）

### ✅ 负责什么

* 实验性功能
* 新想法快速验证
* 业务逻辑扩展
* 非核心控制策略

### ❌ 不负责什么

* 飞行安全
* 姿态与控制闭环
* 强实时任务

### 🧠 一句话理解

> Lua 是：
> **可撤销、可替换、可随时干掉的功能层。**

它存在的意义不是“强大”，而是**降低试错成本**。

---

## 七、总结（一页汇报版）

> ArduPilot 通过 **主飞控 / Lua / AP_Peripheral** 三层架构，
> 在工程复杂度、实时性与系统安全之间取得平衡。
>
> * 主飞控只做要命且必须正确的事
> * AP_Peripheral 隔离非关键外设与复杂 IO
> * Lua 提供低风险的实验与扩展能力
>
> 这种分层设计的核心价值在于：
> **解耦、可控、可演进、不连带失败。**

---

