# ğŸ›°ï¸ ArduPilot SITL + pymavlink é€šä¿¡æµ‹è¯•


> **ç›®æ ‡**ï¼šåœ¨ ArduPilot çš„ SITLï¼ˆSoftware-In-The-Loopï¼‰ä»¿çœŸç¯å¢ƒä¸­ï¼Œ  
> âœ… é€šè¿‡ MAVLink è¯»å–é£æ§æ•°æ®ï¼ˆå§¿æ€ã€ç”µæ± ç­‰ï¼‰  
> âœ… å‘é€è‡ªå®šä¹‰ MAVLink å‘½ä»¤å¹¶éªŒè¯é£æ§å“åº”  

---

## ğŸ§° ä¸€ã€ç¯å¢ƒå‡†å¤‡

### 1. è½¯ä»¶ä¾èµ–
- **ArduPilot æºç **
  ```bash
  git clone https://github.com/ArduPilot/ardupilot.git
  cd ardupilot
  git submodule update --init --recursive
  ```
- **Python åº“**
  ```bash
  pip install pymavlink pyserial
  ```

### 2. å¯åŠ¨ SITLï¼ˆä»¥ Copter ä¸ºä¾‹ï¼‰
```bash
cd ardupilot
sim_vehicle.py -v ArduCopter --console --map
```
- é»˜è®¤å¼€å¯ TCP ç«¯å£ï¼š`127.0.0.1:5760` æˆ–è€…UDPç«¯å£ `udp:127.0.0.1:14550`
- é£æ§ç³»ç»Ÿ ID = 1ï¼Œç»„ä»¶ ID = 0ï¼ˆArduPilot çš„ autopilot ç»„ä»¶ï¼‰
---

## ğŸ“¡ äºŒã€Python è„šæœ¬ï¼šè¿æ¥ + è¯»å– + å‘é€

### å®Œæ•´è„šæœ¬ï¼š`test_ardupilot_sitl.py`

```python
from pymavlink import mavutil
import time

# === 1. è¿æ¥ SITL ===
print("Connecting to ArduPilot SITL...")
master = mavutil.mavlink_connection('udp:127.0.0.1:14550')
master.wait_heartbeat()
print(f"Heartbeat from system {master.target_system}, component {master.target_component}")

# === 2. è¯·æ±‚ç‰¹å®šæ¶ˆæ¯æµï¼ˆæé«˜æ›´æ–°é¢‘ç‡ï¼‰===
def request_message_interval(message_id: int, interval_us: int):
    master.mav.command_long_send(
        master.target_system,
        master.target_component,
        mavutil.mavlink.MAV_CMD_SET_MESSAGE_INTERVAL,
        0,
        message_id,
        interval_us,
        0, 0, 0, 0, 0
    )

# è¯·æ±‚ ATTITUDEï¼ˆ~30Hzï¼‰å’Œ BATTERY_STATUSï¼ˆ1Hzï¼‰
request_message_interval(mavutil.mavlink.MAVLINK_MSG_ID_ATTITUDE, 33333)
request_message_interval(mavutil.mavlink.MAVLINK_MSG_ID_BATTERY_STATUS, 1000000)

# === 3. å‘é€è‡ªå®šä¹‰å‘½ä»¤ï¼ˆæµ‹è¯•ä¸‹è¡Œé“¾è·¯ï¼‰===
print("\nSending custom command: DO_SEND_BANNER...")
master.mav.command_long_send(
    master.target_system,
    master.target_component,
    mavutil.mavlink.MAV_CMD_DO_SEND_BANNER,  # å‘½ä»¤ID: 176
    0, 0, 0, 0, 0, 0, 0, 0
)

# === 4. ç›‘å¬å¹¶è§£ææ•°æ® ===
print("\nListening for ATTITUDE and BATTERY_STATUS...\n")
start_time = time.time()
try:
    while time.time() - start_time < 10:  # è¿è¡Œ10ç§’
        msg = master.recv_match(type=['ATTITUDE', 'BATTERY_STATUS'], blocking=True, timeout=1)
        if not msg:
            continue

        if msg.get_type() == 'ATTITUDE':
            print(f"[ATTITUDE] Roll: {msg.roll:.2f} rad, Pitch: {msg.pitch:.2f}, Yaw: {msg.yaw:.2f}")
        
        elif msg.get_type() == 'BATTERY_STATUS':
            voltage_mv = msg.voltages[0]  # âš ï¸ æ³¨æ„ï¼šMAVLink 2 ä½¿ç”¨ voltages[0]
            if voltage_mv != 65535:       # 65535 = æ— æ•ˆå€¼
                voltage_v = voltage_mv / 1000.0
                current_a = msg.current_battery / 100.0 if msg.current_battery != -1 else 0
                print(f"[BATTERY] Voltage: {voltage_v:.2f} V, Current: {current_a:.1f} A")
            else:
                print("[BATTERY] Invalid data")

except KeyboardInterrupt:
    pass

print("\nâœ… Test completed.")
```

---

## âœ… ä¸‰ã€å…³é”®çŸ¥è¯†ç‚¹è¯´æ˜

### 1. **MAVLink ç‰ˆæœ¬å·®å¼‚ï¼ˆé‡è¦ï¼ï¼‰**

| å­—æ®µ | MAVLink 1 | MAVLink 2ï¼ˆArduPilot é»˜è®¤ï¼‰ |
|------|-----------|----------------------------|
| ç”µæ± ç”µå‹ | `voltage_battery` (mV) | `voltages[0]` (mV) |
| ç”µæµ | `current_battery` (cA) | `current_battery` (cA) |

> â— é”™è¯¯ç¤ºä¾‹ï¼š
> ```python
> msg.voltage_battery  # AttributeError in ArduPilot SITL!
> ```
> âœ… æ­£ç¡®ç”¨æ³•ï¼š
> ```python
> msg.voltages[0]  # æ€»ç”µå‹ï¼ˆæ¯«ä¼ï¼‰
> ```

### 2. **å¸¸ç”¨ MAVLink æ¶ˆæ¯ ID**
| æ¶ˆæ¯å | ID | ç”¨é€” |
|--------|----|------|
| `HEARTBEAT` | 0 | å¿ƒè·³åŒ…ï¼ŒåŒ…å«é£æ§çŠ¶æ€ã€æ¨¡å¼ |
| `ATTITUDE` | 30 | å§¿æ€ï¼ˆroll/pitch/yawï¼Œå•ä½ï¼šå¼§åº¦ï¼‰ |
| `BATTERY_STATUS` | 147 | ç”µæ± ç”µå‹ã€ç”µæµã€å‰©ä½™ç”µé‡ |
| `GPS_RAW_INT` | 24 | GPS åŸå§‹æ•°æ® |

### 3. **è‡ªå®šä¹‰å‘½ä»¤é€‰é¡¹**
| å‘½ä»¤ | ID | è¯´æ˜ |
|------|----|------|
| `MAV_CMD_DO_SEND_BANNER` | 176 | æµ‹è¯•å‘½ä»¤ï¼Œé£æ§ä¼šå‘ GCS å‘é€ banner |
| `MAV_CMD_USER_1` | 31001 | ç”¨æˆ·è‡ªå®šä¹‰å‘½ä»¤ï¼ˆéœ€ Lua è„šæœ¬ç›‘å¬ï¼‰ |
| `MAV_CMD_USER_2~4` | 31002~31004 | åŒä¸Š |

---

## ğŸ§ª å››ã€æµ‹è¯•ç»“æœéªŒè¯

### æˆåŠŸæ ‡å¿— âœ…
- è¾“å‡ºåŒ…å«ï¼š
  ```
  [ATTITUDE] Roll: 0.00 rad, Pitch: 0.00, Yaw: -0.13
  [BATTERY] Voltage: 12.60 V, Current: 28.1 A
  ```
- SITL æ§åˆ¶å°æ˜¾ç¤º `Sent banner to GCS`ï¼ˆè¯æ˜å‘½ä»¤è¢«æ¥æ”¶ï¼‰

### ç»„ä»¶ ID æ³¨æ„
- ArduPilot çš„ autopilot ç»„ä»¶ ID æ˜¯ **0**
- PX4 çš„ autopilot ç»„ä»¶ ID æ˜¯ **1**
- æ‰€ä»¥ `master.target_component == 0` è¡¨ç¤ºè¿æ¥çš„æ˜¯ ArduPilot

---

> âœï¸ **è®°å½•äºº**ï¼šShikun  
> ğŸ“… **æ—¥æœŸ**ï¼š2025-12-15  
> ğŸ’¡ **å¤‡æ³¨**ï¼šæ­¤æµç¨‹å·²åœ¨ Ubuntu + ArduPilot v4.5+ SITL ç¯å¢ƒéªŒè¯é€šè¿‡
