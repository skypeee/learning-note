这个文档记录当前要处理的任务，这个文档要及时整理


我现在做不到不查资料给你答案，因为我完全没了解这两个东西在ardupilot里的概念
AP_Peripheral
Lua Script

### Q1：

**AP_Peripheral 在无人机系统中“是什么”？**
AP_peripheral 在ardupilot代码仓库里的tools/AP_Periph目录下，他应该是负责处理外设相关的子系统吧，但是我对他负责处理外设的概念理解的比较笼统，好像可以驱动DroneCAN 的外设固件

---

### Q2：

**AP_Peripheral 适合承担哪些类型的功能？为什么这些功能不放主飞控？**

他是不是负责外设的输入输出和信息交互，因为这些实时性要求没有那么高，而且没处理完信息也不会有太高的风险，并且调度可以控制，复杂度不高，所以不适合放在飞控里


---

### Q3：

**Lua Script 在 ArduPilot 中“扮演什么角色”？**

他是ardupilot提供的一个沙箱运行的子模块，可以在不修改源飞控代码的前提下，加功能或者逻辑，而基于lua运行，会在内存上运行，即时运行崩了，也不会影响飞控的核心功能，不会因为脚本错误而影响飞控炸机，可以做一些监控的功能或者操作飞控的功能，因为是单独的脚本，也不用担心后续升级源仓库导致合并不上去的问题
---

### Q4：

**如果一个功能：
不确定是否长期保留、
不确定是否 100% 正确、
但又“想先跑起来看看”，
你会放在哪？为什么？**
那肯定会放在lua脚本上，先测试，不影响飞控的原功能
---



Q5（核心题）：

如果领导问你一句话：
“为什么 ArduPilot 不把这些功能都写在主飞控里？”
你会怎么回答？

要求：

首先从软件工程的角度出发，解耦核心飞控逻辑与外设逻辑，分别维护，可以让核心飞控尽可能简单，简单意味着好维护和少出错；其次，这两部分的实时性要求是不一样的，飞控和核心外设要求实时性高，必须首先处理，非核心外设实时性不高可以放到AP_Peripheral里；再次是风险，飞控核心逻辑出现问题，风险特别高，把非核心外设放到飞控里，复杂性高了出错概率就高了；


Q6（结构题）：

请你用“3 层结构”描述：
主飞控 / Lua / AP_Peripheral
各自负责什么，不负责什么

主飞控：核心飞控逻辑、核心关键外设
lua：非核心功能，或者新功能，或者非核心功能
AP_Peripheral：非核心外设

主飞控：
1. 姿态控制
2. 安全返航
3. 控制闭环
4. 逻辑可推导
5. 飞行模式比如加速、升高、降落等控制
一句话理解，控制的内容必须确定、必须正确、必须可推到，不可负责复杂IO、不可控时间的逻辑、实验性的功能。
任何复杂的逻辑和IO内容，出错都会影响以上核心逻辑的运行和推导
AP_Peripheral
1. 非飞行关键数据获取
2. 非飞行必要的外设
3. 复杂的功能
不负责姿态、控制、安全相关的内容
Lua
1. 实验性的功能，可撤销
2. 可扩展性强
3. 沙盒运行，可便于干掉的内容
不能负责安全、核心姿态及控制


Q8：
请你用 5～7 行话，
向领导解释：
“AP_Peripheral + Lua 的存在，
如何帮助 ArduPilot 在不牺牲飞行安全的前提下扩展功能？”

1. ardupilot负责姿态、控制、飞行关键外设；Apperipheral负责非飞行关键外设，比如传感器、外设、非核心功能；lua负责实验性功能，可撤销；从架构设计的角度出发，代码解耦会让开发更加简单；从实时性角度出发，ardupilot负责的都是要命的核心功能，分层让其他两层不干扰核心的逻辑处理；

🎯 Task 1（结构理解 · 必答）

请你回答这个问题（当作给技术负责人汇报）：

如果我现在要接一个“新传感器 + 新飞行辅助功能”，
我该如何判断：它应该放在主飞控、AP_Peripheral，还是 Lua？

要求

新飞行辅助功能放到Lua、新传感器放到AP_Peripheral
新传感器是非关键外设，他是否出问题，不应该影响飞控，所以要放到AP_Peripheral
新飞行辅助功能是实验性功能，他可能出问题，会影响飞控，而且是实验性质的内容，要可撤销，不可影响飞控，所以要放到Lua


🎯 Task 2（进阶 · 关键）

请你回答这个问题（不用看代码）：

AP_Peripheral 和 Lua 都“不在主飞控里”，
那为什么 ArduPilot 还要同时保留这两层？
只留 Lua 或只留 AP_Peripheral 行不行？为什么不行？

只留lua或者只留ap_peripheral都不行
不要ap_peripheral的话，新传感器上来，就只能放到ardupilot里，这样会让ardupilot代码量变大，并且ardupilot需要负责与安全、控制、姿态等职责无关的内容，并且会加大时许控制的风险
只留ap_peripheral的话，新的实验性功能上来，会影响arudupilot的代码，让ardupliopt难以推导，难以撤销，增加代码维护的难度


如果把一个“偶尔会阻塞 2~3ms 的任务”错误地放进主飞控 FAST_TASK，会发生什么？你如何从系统层面预判这种风险？

影响任务的时序，主飞控需要在固定时间内进行运行检查，如果这个任务偶尔会阻塞，会拖慢飞行检查的时效，严重时会让一些任务超时，导致飞控核心逻辑降频，更严重会影响飞控链接，最终导致崩溃；预判的建议，每个任务都有指定的运行时间，超过运行时间会有标记，检测到超时如果非必要任务会打断，如果必要任务那就让主飞控降低任务频率，并且与地面站交互，如果降频严重则返航